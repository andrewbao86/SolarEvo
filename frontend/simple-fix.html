<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BESS Capacity Calculator - Working Version</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <script>
        if (typeof ChartDataLabels !== 'undefined') {
            Chart.register(ChartDataLabels);
            console.log('‚úÖ ChartDataLabels plugin registered successfully');
        } else {
            console.warn('‚ö†Ô∏è ChartDataLabels plugin not found');
        }
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <img src="assets/bao-service-logo.svg" alt="Bao Service Logo" class="logo">
            <h1>BESS Capacity Calculator</h1>
            <p>Calculate your battery energy storage system requirements</p>
        </header>

        <main>
            <!-- CSV Section -->
            <section class="device-input">
                <h2>CSV Import/Export</h2>
                <div class="bulk-upload-section">
                    <h3>Bulk Upload (CSV)</h3>
                    <div class="bulk-upload-controls">
                        <div class="upload-actions">
                            <button type="button" id="download-csv-template" class="template-btn">
                                üì• Download CSV Template
                            </button>
                            <div class="file-upload-wrapper">
                                <input type="file" id="csv-file-input" accept=".csv" style="display: none;">
                                <button type="button" id="upload-csv-btn" class="upload-btn">
                                    üì§ Upload CSV File
                                </button>
                            </div>
                        </div>
                        <p class="upload-info">Upload multiple devices at once using our CSV template</p>
                    </div>
                </div>
                <div id="csv-status" style="margin: 10px 0; padding: 10px; border-radius: 5px; display: none;"></div>
                <div id="csv-results"></div>
            </section>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        console.log('üöÄ Working CSV version loaded');
        
        const csvTemplate = [
            { name: 'Air Conditioner', power: 2000, quantity: 2, operatinghours: '08:00 - 18:00', batteryhours: '18:00 - 22:00', critical: 'false' },
            { name: 'Refrigerator', power: 150, quantity: 1, operatinghours: '00:00 - 24:00', batteryhours: '18:00 - 08:00', critical: 'true' },
            { name: 'LED Lights', power: 15, quantity: 10, operatinghours: '18:00 - 24:00', batteryhours: '18:00 - 24:00', critical: 'false' },
            { name: 'Television', power: 120, quantity: 1, operatinghours: '19:00 - 23:00', batteryhours: '19:00 - 23:00', critical: 'false' },
            { name: 'Washing Machine', power: 500, quantity: 1, operatinghours: '08:00 - 10:00', batteryhours: '', critical: 'false' },
            { name: 'Router', power: 10, quantity: 1, operatinghours: '00:00 - 24:00', batteryhours: '18:00 - 08:00', critical: 'true' }
        ];
        
        function showStatus(message, type = 'info') {
            console.log(message);
            const statusDiv = document.getElementById('csv-status');
            statusDiv.style.display = 'block';
            statusDiv.className = type === 'success' ? 'alert alert-success' : 
                                 type === 'error' ? 'alert alert-danger' : 'alert alert-info';
            statusDiv.textContent = message;
        }
        
        function arrayToCsv(data) {
            const headers = ['name', 'power', 'quantity', 'operatinghours', 'batteryhours', 'critical'];
            const csvRows = [headers.join(',')];
            
            data.forEach(row => {
                const values = headers.map(header => {
                    const value = row[header] || '';
                    return typeof value === 'string' && value.includes(',') ? `"${value}"` : value;
                });
                csvRows.push(values.join(','));
            });
            
            return csvRows.join('\n');
        }
        
        function downloadCsv(content, filename) {
            const blob = new Blob([content], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            link.click();
            URL.revokeObjectURL(url);
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üìã DOM ready');
            
            document.getElementById('download-csv-template').addEventListener('click', function() {
                console.log('üì• Download clicked');
                const csvContent = arrayToCsv(csvTemplate);
                downloadCsv(csvContent, 'template.csv');
                showStatus('‚úÖ Downloaded successfully!', 'success');
            });
            
            document.getElementById('upload-csv-btn').addEventListener('click', function() {
                console.log('üì§ Upload clicked');
                document.getElementById('csv-file-input').click();
            });
            
            document.getElementById('csv-file-input').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                console.log('üìÇ File selected:', file.name);
                showStatus('Processing...', 'info');
                
                Papa.parse(file, {
                    header: true,
                    skipEmptyLines: true,
                    transformHeader: function(header) {
                        return header.toLowerCase().trim().replace(/\s+/g, '');
                    },
                    complete: function(result) {
                        console.log('Result:', result);
                        showStatus(`‚úÖ Parsed ${result.data.length} rows`, 'success');
                        document.getElementById('csv-results').innerHTML = 
                            '<h4>Parsed Data:</h4>' + 
                            '<pre style="background: #f5f5f5; padding: 10px; border-radius: 5px; overflow-x: auto;">' + 
                            JSON.stringify(result.data, null, 2) + '</pre>';
                    },
                    error: function(error) {
                        console.error('Error:', error);
                        showStatus('‚ùå Error: ' + error.message, 'error');
                    }
                });
            });
            
            showStatus('‚úÖ Ready to test CSV functionality', 'success');
        });
    </script>
</body>
</html> 