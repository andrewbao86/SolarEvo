<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BESS Capacity Calculator</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap">
    <!-- Add Font Awesome for social media icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <!-- Add Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Add Chart.js annotation plugin -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation"></script>
    <!-- Add Chart.js data labels plugin -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <script>
        // Register ChartDataLabels plugin globally
        if (typeof ChartDataLabels !== 'undefined') {
            Chart.register(ChartDataLabels);
            console.log('‚úÖ ChartDataLabels plugin registered successfully');
        } else {
            console.warn('‚ö†Ô∏è ChartDataLabels plugin not found');
        }
    </script>
</head>
<body>
    <div class="container">
        <header>
            <img src="assets/bao-service-logo.svg" alt="Bao Service Logo" class="logo">
            <h1>BESS Capacity Calculator</h1>
            <p>Calculate your battery energy storage system requirements</p>
        </header>

        <main>
            <!-- Prospect Information Input -->
            <div class="prospect-inputs">
                <div class="prospect-row">
                    <div class="prospect-field">
                        <label for="prospect-name">Your Name</label>
                        <input type="text" id="prospect-name" placeholder="Your Name" required>
                    </div>
                    <div class="prospect-field">
                        <label for="prospect-email">Email</label>
                        <input type="email" id="prospect-email" placeholder="your.email@example.com" required>
                    </div>
                    <div class="prospect-field">
                        <label for="prospect-mobile">Mobile Number</label>
                        <input type="tel" id="prospect-mobile" placeholder="+60123456789" required>
                    </div>
                </div>
            </div>
            <!-- Device List Section -->
            <section class="device-list">
                <div class="device-list-header">
                    <h2>Devices</h2>
                    <button class="clear-all-button" id="clear-all" data-tooltip="Remove all devices">Clear All</button>
                </div>
                <div class="device-list-table">
                    <div class="device-list-row device-list-header-row">
                        <div>Device</div>
                        <div>Power (W)</div>
                        <div>Quantity</div>
                        <div>Operating Hours</div>
                        <div>Hours on Battery</div>
                        <div>Actions</div>
                    </div>
                    <div id="devices-container">
                        <!-- Device entries will be added here dynamically -->
                    </div>
                </div>
            </section>

            <!-- Add Device Section -->
            <section class="device-input">
                <h2>Add Device</h2>
                
                <!-- Bulk Upload Section -->
                <div class="bulk-upload-section">
                    <h3>Bulk Upload (CSV)</h3>
                    <div class="bulk-upload-controls">
                        <div class="upload-actions">
                            <button type="button" id="download-csv-template" class="template-btn">
                                üì• Download CSV Template
                            </button>
                            <div class="file-upload-wrapper">
                                <input type="file" id="csv-file-input" accept=".csv" style="display: none;">
                                <button type="button" id="upload-csv-btn" class="upload-btn">
                                    üì§ Upload CSV File
                                </button>
                            </div>
                        </div>
                        <p class="upload-info">Upload multiple devices at once using our CSV template</p>
                    </div>
                </div>

                <div class="method-divider">
                    <span>OR</span>
                </div>

                <!-- Single Device Form -->
                <h3>Add Single Device</h3>
                <form id="add-device-form" autocomplete="off">
                    <div class="input-row apple-input-row add-device-row-flex">
                        <div class="input-group apple-input-group">
                            <label for="device">Device</label>
                            <input type="text" id="device" placeholder="e.g., Fridge, Lamp" list="device-suggestions" class="apple-input">
                            <datalist id="device-suggestions"></datalist>
                        </div>
                        <div class="input-group apple-input-group">
                            <label for="power">Power (W)</label>
                            <input type="number" id="power" placeholder="e.g., 250" class="apple-input">
                        </div>
                        <div class="input-group apple-input-group">
                            <label for="quantity">Quantity</label>
                            <input type="number" id="quantity" value="1" class="apple-input">
                        </div>
                    </div>
                    <div class="block-picker-row">
                        <label>Operating Hours</label>
                        <div class="time-block-picker large" id="operating-hours-blocks"></div>
                        <div class="time-blocks-display" id="operating-hours-blocks-display"></div>
                        <button class="clear-blocks-btn" id="clear-operating-blocks">Clear Selection</button>
                    </div>
                    <div class="block-picker-row">
                        <label>Hours on Battery</label>
                        <div class="time-block-picker large" id="battery-hours-blocks"></div>
                        <div class="time-blocks-display" id="battery-hours-blocks-display"></div>
                        <button class="clear-blocks-btn" id="clear-battery-blocks">Clear Selection</button>
                    </div>
                    <div class="bottom-controls-row">
                        <div class="input-group checkbox-group">
                            <label for="critical-device">
                                <input type="checkbox" id="critical-device">
                                Critical Device
                            </label>
                        </div>
                        <div class="add-btn-container">
                            <button id="add-device" class="add-button apple-btn" disabled>Add</button>
                        </div>
                    </div>
                </form>
            </section>

            <!-- New Visualization Section -->
            <section class="visualizations">
                <h2>Energy Analysis</h2>
                <div class="chart-container full-width">
                    <div class="chart-wrapper">
                        <h3>Daily Energy Consumption</h3>
                        <canvas id="energyDistributionChart"></canvas>
                    </div>
                </div>
                <div class="chart-container">
                    <div class="chart-wrapper">
                        <h3>Device-wise Energy Usage</h3>
                        <canvas id="deviceEnergyChart"></canvas>
                    </div>
                    <div class="chart-wrapper">
                        <h3>Estimated Monthly Cost Savings (Malaysia)</h3>
                        <canvas id="costComparisonChart"></canvas>
                    </div>
                </div>
            </section>

            <!-- Results section styled as cards, two rows -->
            <section class="results">
                <h2>Results</h2>
                <div class="result-cards card-grid">
                    <div class="result-card card-half">
                        <h3>Total Daily Energy</h3>
                        <p id="total-energy">0 kWh</p>
                    </div>
                    <div class="result-card card-half">
                        <h3>Battery Capacity Required</h3>
                        <p id="battery-capacity">0 kWh</p>
                    </div>
                    <div class="result-card card-half">
                        <h3>Recommended Solar Size</h3>
                        <p id="solar-size">0 kWp</p>
                    </div>
                    <div class="result-card card-half">
                        <h3>Recommended BESS Size</h3>
                        <p id="recommended-size">0 kWh</p>
                    </div>
                    <div class="result-card recommendation-card">
                        <h3>SolarEvo BESS Recommendation</h3>
                        <p id="solarevo-recommendation">-</p>
                        <div class="action-buttons">
                            <button id="download-pdf" class="report-button" disabled>Download PDF Report</button>
                            <button id="generate-share-link" class="share-button" disabled>Generate Shareable Link</button>
                        </div>
                    </div>
                </div>
            </section>
        </main>

        <footer>
            <p>¬© 2025 SolarEvo | Bao Service</p>
            <div class="social-links">
                <!-- These links will need to be updated with your actual URLs -->
                <a href="https://www.tiktok.com/@solarevo.my" class="social-icon" id="tiktok-link" target="_blank" rel="noopener noreferrer">
                    <i class="fab fa-tiktok"></i>
                </a>
                <a href="https://www.instagram.com/solarevo.my" class="social-icon" id="instagram-link" target="_blank" rel="noopener noreferrer">
                    <i class="fab fa-instagram"></i>
                </a>
                <a href="https://api.whatsapp.com/send?phone=60163016170" class="social-icon" id="whatsapp-link" target="_blank" rel="noopener noreferrer">
                    <i class="fab fa-whatsapp"></i>
                </a>
                <a href="https://www.baoservice.net/solarevo" class="social-icon" id="website-link" target="_blank" rel="noopener noreferrer">
                    <i class="fas fa-globe"></i>
                </a>
                <!-- Admin access link -->
                <a href="admin.html" class="social-icon admin-link" id="admin-link" title="Admin Dashboard">
                    <i class="fas fa-cog"></i>
                </a>
            </div>
        </footer>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Papa Parse for CSV processing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <!-- jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- jsPDF autoTable plugin for table generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <!-- LZ-String for advanced compression -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"></script>
    
    <!-- Load Application Modules -->
    <script type="module" src="js/modules/app-state.js"></script>
    <script type="module" src="js/modules/storage-manager.js"></script>
    <script type="module" src="js/modules/calculations.js"></script>
    <script type="module" src="js/modules/time-blocks.js"></script>
    <script type="module" src="js/modules/device-manager.js"></script>
    <script type="module" src="js/modules/csv-handler.js"></script>
    <script type="module" src="js/modules/ui-controller.js"></script>
    <script type="module" src="js/modules/modal-manager.js"></script>
    <script type="module" src="js/modules/charts.js"></script>
    <script type="module" src="js/modules/pdf-generator.js"></script>
    <script type="module" src="js/modules/share-service.js"></script>
    
    <!-- Backend Service V2 for Database-Stored Sharing -->
    <script type="module" src="js/services/backend-service-v2.js"></script>
    
    <!-- Main Application Script -->
    <script type="module" src="main.js"></script>
    
    <!-- CSV Functionality - Integrated with proper modules -->
    <script>
        console.log('üöÄ CSV functionality loading...');
        
        // CSV Template data for fallback
        const csvTemplate = [
            { name: 'Air Conditioner', power: 2000, quantity: 2, operatinghours: '08:00 - 18:00', batteryhours: '18:00 - 22:00', critical: 'false' },
            { name: 'Refrigerator', power: 150, quantity: 1, operatinghours: '00:00 - 24:00', batteryhours: '18:00 - 08:00', critical: 'true' },
            { name: 'LED Lights', power: 15, quantity: 10, operatinghours: '18:00 - 24:00', batteryhours: '18:00 - 24:00', critical: 'false' },
            { name: 'Television', power: 120, quantity: 1, operatinghours: '19:00 - 23:00', batteryhours: '19:00 - 23:00', critical: 'false' },
            { name: 'Washing Machine', power: 500, quantity: 1, operatinghours: '08:00 - 10:00', batteryhours: '', critical: 'false' },
            { name: 'Router', power: 10, quantity: 1, operatinghours: '00:00 - 24:00', batteryhours: '18:00 - 08:00', critical: 'true' }
        ];
        
        function showCsvStatus(message, type = 'info') {
            console.log('üìä CSV Status:', message);
            // You can add visual status updates here if needed
            if (type === 'error') {
                alert('‚ùå ' + message);
            } else if (type === 'success') {
                console.log('‚úÖ ' + message);
            }
        }
        
        function arrayToCsv(data) {
            const headers = ['name', 'power', 'quantity', 'operatinghours', 'batteryhours', 'critical'];
            const csvRows = [headers.join(',')];
            
            data.forEach(row => {
                const values = headers.map(header => {
                    const value = row[header] || '';
                    return typeof value === 'string' && value.includes(',') ? `"${value}"` : value;
                });
                csvRows.push(values.join(','));
            });
            
            return csvRows.join('\n');
        }
        
        function downloadCsv(content, filename) {
            const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }
        
        // Parse time range string to hour array
        function parseTimeRangeToHours(timeRange) {
            if (!timeRange || timeRange.trim() === '') return [];
            
            try {
                // Handle formats like "08:00 - 18:00", "18:00 - 22:00", "00:00 - 24:00"
                const match = timeRange.match(/(\d{2}):00\s*-\s*(\d{2}):00/);
                if (match) {
                    const startHour = parseInt(match[1]);
                    let endHour = parseInt(match[2]);
                    
                    // Handle 24:00 as midnight of next day
                    if (endHour === 24) endHour = 0;
                    
                    const hours = [];
                    if (startHour <= endHour) {
                        // Normal range (e.g., 8-18)
                        for (let h = startHour; h < endHour; h++) {
                            hours.push(h);
                        }
                    } else {
                        // Overnight range (e.g., 18-8)
                        for (let h = startHour; h < 24; h++) {
                            hours.push(h);
                        }
                        for (let h = 0; h < endHour; h++) {
                            hours.push(h);
                        }
                    }
                    return hours;
                }
                
                // If no match, try to parse as comma-separated hours
                return timeRange.split(',')
                    .map(h => parseInt(h.trim()))
                    .filter(h => !isNaN(h) && h >= 0 && h <= 23);
                    
            } catch (error) {
                console.warn('Failed to parse time range:', timeRange, error);
                return [];
            }
        }
        
        // Convert CSV data to devices that can be added to the app
        function convertCsvToDevices(csvData) {
            return csvData.map(row => {
                const device = {
                    id: 'csv_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                    name: row.name ? row.name.trim() : '',
                    power: parseFloat(row.power) || 0,
                    quantity: parseInt(row.quantity) || 1,
                    operatingHours: parseTimeRangeToHours(row.operatinghours || ''),
                    batteryHours: parseTimeRangeToHours(row.batteryhours || ''),
                    critical: (row.critical || '').toLowerCase() === 'true'
                };
                
                return device;
            }).filter(device => device.name && device.power > 0); // Only keep valid devices
        }
        
        // Add devices to the app state
        function addDevicesToApp(devices, action = 'replace') {
            console.log('üìù Adding devices to app:', devices.length, 'devices, action:', action);
            
            // Check if we have the required modules
            if (typeof window.AppState === 'undefined') {
                console.warn('‚ö†Ô∏è AppState module not found, using fallback method');
                // Fallback: dispatch a custom event with the devices
                const event = new CustomEvent('csvDevicesReady', {
                    detail: { devices, action }
                });
                document.dispatchEvent(event);
                return;
            }
            
            try {
                if (action === 'replace') {
                    // Clear existing devices and add new ones
                    window.AppState.setDevices([]);
                    devices.forEach(device => {
                        window.AppState.addDevice(device);
                    });
                    showCsvStatus(`Replaced with ${devices.length} devices from CSV!`, 'success');
                } else {
                    // Add to existing devices
                    devices.forEach(device => {
                        window.AppState.addDevice(device);
                    });
                    showCsvStatus(`Added ${devices.length} devices from CSV!`, 'success');
                }
                
                // Trigger UI updates
                const event = new CustomEvent('devicesUpdated', {
                    detail: { devices, action }
                });
                document.dispatchEvent(event);
                
            } catch (error) {
                console.error('‚ùå Error adding devices to app:', error);
                showCsvStatus('Failed to add devices: ' + error.message, 'error');
            }
        }
        
        // Listen for devices updated events from CSV import
        document.addEventListener('devicesUpdated', function(event) {
            console.log('üìä Devices updated from CSV:', event.detail);
            // Force re-render of UI elements that might be managed by other scripts
            const devicesContainer = document.getElementById('devices-container');
            if (devicesContainer && event.detail.devices) {
                // Trigger any charts or calculations updates that might be managed by main.js
                if (typeof window.updateCalculations === 'function') {
                    window.updateCalculations();
                }
                if (typeof window.renderDevices === 'function') {
                    window.renderDevices();
                }
            }
        });
        
        // CSV functionality is handled by the main application modules
        // This script just provides utility functions as fallbacks
        console.log('‚ÑπÔ∏è CSV functionality handled by main application modules (CsvHandler, main.js)');
    </script>
</body>
</html>